<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <title>TIU x The Biriyani Canteen - Checkout</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        :root {
            --primary: #ff6b35;
            --primary-dark: #e85d2e;
            --bg-cream: #fff8f0;
            --secondary: #f7931e;
            --brown: #6b4423;
            --success-green: #60b246;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-cream); color: #333; padding-bottom: 2rem; }
        .navbar { background: white; padding: 0.75rem 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .nav-left { display: flex; align-items: center; gap: 1rem; }
        .hamburger { display: flex; flex-direction: column; gap: 4px; cursor: pointer; padding: 0.5rem; }
        .hamburger span { width: 22px; height: 2.5px; background: var(--brown); border-radius: 3px; transition: all 0.3s; }
        .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(7px, 7px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
        .logo { font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: bold; color: var(--primary); cursor: pointer; }
        .nav-items { display: none; position: fixed; top: 60px; left: 0; right: 0; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 0.5rem; flex-direction: column; gap: 0; z-index: 999; }
        .nav-items.active { display: flex; }
        .nav-item { cursor: pointer; padding: 0.9rem; border-radius: 8px; transition: background 0.3s; text-decoration: none; color: #333; font-weight: 500; font-size: 0.95rem; border-bottom: 1px solid #f0f0f0; }
        .nav-item:hover { background: var(--bg-cream); }
        .container { max-width: 900px; margin: 1rem auto; padding: 0 0.75rem; }
        .cart-container, .section-container { background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 1rem; }
        h2 { margin-bottom: 1rem; color: var(--primary); font-size: clamp(1.3rem, 4vw, 1.6rem); }
        .cart-item { display: flex; flex-direction: column; gap: 0.75rem; padding: 0.9rem; border-bottom: 1px solid #eee; }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem; }
        .cart-item-details { flex: 1; min-width: 0; }
        .cart-item-name { font-size: clamp(0.95rem, 3vw, 1.05rem); font-weight: 600; margin-bottom: 0.2rem; word-wrap: break-word; }
        .cart-item-price { color: var(--brown); font-weight: 600; font-size: clamp(0.85rem, 2.5vw, 0.95rem); }
        .cart-item-actions { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
        .cart-item-quantity { display: flex; align-items: center; gap: 0.6rem; }
        .quantity-btn { background: var(--primary); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .quantity-btn:active { transform: scale(0.9); }
        .quantity-display { font-size: 1rem; font-weight: 600; min-width: 25px; text-align: center; }
        .cart-item-total { font-size: clamp(1rem, 3vw, 1.15rem); font-weight: bold; color: #333; }
        .remove-btn { background: #dc3545; color: white; border: none; padding: 0.5rem 0.85rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; }
        .remove-btn:active { transform: scale(0.95); }
        .cart-summary { margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #eee; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.75rem; font-size: clamp(0.9rem, 2.5vw, 1rem); }
        .summary-row.subtotal { color: #666; }
        .summary-row.delivery { color: #666; }
        .summary-row.delivery.free { color: var(--success-green); font-weight: 600; }
        .summary-row.delivery.free .delivery-value { text-decoration: line-through; color: #999; margin-right: 0.5rem; }
        .cart-total { display: flex; justify-content: space-between; font-size: clamp(1.3rem, 4vw, 1.5rem); font-weight: bold; color: var(--brown); margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #eee; }
        .section-title { font-size: clamp(1.1rem, 3vw, 1.3rem); font-weight: 600; color: #333; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .room-display-card { border: 2px solid var(--secondary); border-radius: 10px; padding: 0.9rem; background: #f0f9ff; }
        .room-display-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .room-display-name { font-weight: 600; font-size: 1rem; color: #333; }
        .change-room-btn { background: var(--primary); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.3s; }
        .change-room-btn:active { transform: scale(0.95); }
        .room-display-phone { color: #666; font-size: 0.85rem; margin-bottom: 0.5rem; }
        .room-display-text { color: #555; line-height: 1.5; font-size: 0.9rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 600; color: #333; font-size: clamp(0.85rem, 2.5vw, 0.95rem); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: clamp(0.85rem, 2.5vw, 0.95rem); font-family: inherit; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-group textarea { resize: vertical; min-height: 70px; }
        .info-instruction { background: #e8f4fd; border-left: 4px solid var(--primary); padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px; font-size: 0.85rem; color: #555; }
        .room-card { border: 2px solid #e0e0e0; border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.3s; position: relative; }
        .room-card:hover { border-color: var(--primary); background: #fffbf0; }
        .room-card.selected { border-color: var(--primary); background: #fffbf0; box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2); }
        .room-card.selected::before { content: '‚úì'; position: absolute; top: 10px; right: 10px; background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; }
        .room-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.6rem; padding-right: 30px; }
        .room-name { font-weight: 600; font-size: 1rem; color: #333; }
        .room-phone { color: #666; font-size: 0.85rem; margin-top: 0.2rem; }
        .room-details { color: #666; line-height: 1.5; font-size: 0.85rem; }
        .room-actions { display: flex; gap: 0.6rem; margin-top: 0.75rem; flex-wrap: wrap; }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-set-default { background: var(--secondary); color: white; }
        .btn-set-default:active { transform: scale(0.95); }
        .btn-delete { background: #dc3545; color: white; }
        .btn-delete:active { transform: scale(0.95); }
        .default-badge { background: var(--secondary); color: white; padding: 0.2rem 0.6rem; border-radius: 5px; font-size: 0.75rem; font-weight: 600; }
        .payment-option { display: flex; align-items: center; padding: 1rem; border: 2px solid #eee; border-radius: 10px; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.3s; }
        .payment-option:hover, .payment-option.selected { border-color: var(--primary); background: #fffbf0; }
        .payment-option input[type="radio"] { width: 18px; height: 18px; margin-right: 0.9rem; cursor: pointer; accent-color: var(--primary); }
        .payment-details { flex: 1; }
        .payment-title { font-size: clamp(0.95rem, 3vw, 1.05rem); font-weight: 600; margin-bottom: 0.2rem; }
        .payment-description { color: #666; font-size: clamp(0.8rem, 2vw, 0.85rem); }
        .btn { width: 100%; padding: 1rem; background: var(--brown); color: white; border: none; border-radius: 10px; font-size: clamp(1rem, 3vw, 1.1rem); font-weight: 600; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.98); box-shadow: inset 0 3px 8px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn.processing { background: #5989b3; pointer-events: none; }
        .btn.processing::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
        .btn-secondary { width: 100%; padding: 0.9rem; background: white; color: var(--primary); border: 2px solid var(--primary); border-radius: 10px; font-size: clamp(0.95rem, 3vw, 1.05rem); font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-secondary:active { transform: scale(0.98); background: var(--bg-cream); }
        .empty-cart { text-align: center; padding: 2.5rem 1rem; }
        .empty-cart-icon { font-size: clamp(3rem, 10vw, 4rem); margin-bottom: 0.75rem; }
        .empty-cart h3 { color: #666; margin-bottom: 0.75rem; font-size: clamp(1.1rem, 3vw, 1.3rem); }
        .continue-shopping { display: inline-flex; margin-top: 0.75rem; padding: 0.7rem 1.5rem; background: var(--primary); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s; }
        .continue-shopping:active { transform: scale(0.95); }
        .success-message, .error-message { padding: 0.9rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; font-weight: 600; display: none; font-size: 0.9rem; }
        .success-message { background: #d4edda; color: #155724; }
        .error-message { background: #f8d7da; color: #721c24; }
        .loader { display: none; text-align: center; padding: 0.75rem; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 1.5rem 2rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; display: none; text-align: center; min-width: 280px; max-width: 90%; animation: toastSlideIn 0.3s ease-out; }
        .toast.show { display: block; }
        .toast-success { border-left: 5px solid var(--secondary); }
        .toast-error { border-left: 5px solid #dc3545; }
        .toast-icon { font-size: 3rem; margin-bottom: 0.75rem; }
        .toast-message { font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 0.5rem; }
        .toast-submessage { font-size: 0.9rem; color: #666; }
        @keyframes toastSlideIn { from { transform: translate(-50%, -60%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
        .toast-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 9999; display: none; }
        .toast-overlay.show { display: block; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; animation: fadeIn 0.3s; }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { background: white; border-radius: 12px; padding: 1.25rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
        .modal-title { font-size: 1.3rem; font-weight: 600; color: #333; }
        .close-modal { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #666; line-height: 1; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .rooms-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #f0f0f0; }
        .rooms-list-title { font-size: 1.1rem; font-weight: 600; color: #333; }
        .empty-rooms { text-align: center; padding: 2rem 1rem; color: #666; }
        .empty-rooms-icon { font-size: 3rem; margin-bottom: 0.5rem; }
        .hint-text { font-size: 0.8rem; color: #888; margin-top: 0.3rem; font-style: italic; }
        @media (min-width: 768px) {
            .cart-item { flex-direction: row; align-items: center; }
            .quantity-btn:hover { background: var(--secondary); transform: scale(1.1); }
            .remove-btn:hover { background: #c82333; }
            .btn:hover:not(:disabled) { background: #5989b3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(103, 152, 192, 0.4); }
            .btn:active:not(:disabled) { transform: translateY(0); }
            .btn-secondary:hover { background: var(--bg-cream); border-color: var(--secondary); color: var(--secondary); transform: translateY(-2px); }
            .btn-secondary:active { transform: translateY(0); }
            .hamburger { display: none; }
            .nav-items { display: flex !important; position: static; flex-direction: row; padding: 0; box-shadow: none; gap: 0.75rem; }
            .nav-item { border-bottom: none; padding: 0.4rem 0.6rem; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="nav-left">
            <div class="hamburger" onclick="APP.toggleMenu()">
                <span></span><span></span><span></span>
            </div>
            <div class="logo" onclick="window.location.href='home.html'">üçõ TIU Biriyani</div>
        </div>
    </div>

    <div class="nav-items" id="navMenu">
        <a href="home.html" class="nav-item">Home</a>
        <a href="orders.html" class="nav-item">Orders</a>
        <a href="checkout.html" class="nav-item">Cart</a>
        <span class="nav-item" onclick="APP.logout()" style="cursor:pointer;">Logout</span>
    </div>

    <div class="container">
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>

        <div class="toast-overlay" id="toastOverlay"></div>
        <div class="toast" id="toast">
            <div class="toast-icon" id="toastIcon"></div>
            <div class="toast-message" id="toastMessage"></div>
            <div class="toast-submessage" id="toastSubMessage"></div>
        </div>

        <div class="cart-container">
            <h2>Your Cart</h2>
            <div id="cartContent"></div>
        </div>

        <div id="checkoutSections" style="display: none;">
            <div class="section-container">
                <div class="section-title">üö™ Delivery Location</div>
                <div id="roomDisplayArea"></div>
            </div>

            <div class="section-container">
                <div class="section-title">üí≥ Payment Method</div>
                <div class="payment-option" id="payment-cod" onclick="APP.selectPayment('cod')">
                    <input type="radio" name="payment" id="cod" value="cod">
                    <div class="payment-details">
                        <div class="payment-title">Cash on Delivery</div>
                        <div class="payment-description">Pay when order arrives</div>
                    </div>
                </div>
                <div class="payment-option" id="payment-online" onclick="APP.selectPayment('online')">
                    <input type="radio" name="payment" id="online" value="online">
                    <div class="payment-details">
                        <div class="payment-title">Online Payment</div>
                        <div class="payment-description">Razorpay (UPI, Card, Net Banking)</div>
                    </div>
                </div>
                <div class="loader" id="loader">
                    <div class="spinner"></div>
                    <p style="margin-top: 0.75rem; color: #666; font-size: 0.9rem;">Processing...</p>
                </div>
                <button class="btn" id="placeOrderBtn" onclick="APP.handlePlaceOrder()" disabled>Select Payment Method</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="roomModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üö™ Delivery Location</div>
                <button class="close-modal" onclick="APP.closeRoomModal()">&times;</button>
            </div>

            <div id="savedRoomsList" style="display: none;">
                <div class="rooms-list-header">
                    <div class="rooms-list-title">Saved Locations</div>
                </div>
                <div id="roomCards"></div>
                <button type="button" class="btn-secondary" onclick="APP.showRoomForm()" style="margin-top: 0.75rem;">+ Add New Location</button>
            </div>

            <div id="roomFormContainer" style="display:none;">
                <div class="info-instruction">
                    üè¢ <strong>Campus Delivery:</strong> Enter your room and building details for quick delivery within TIU campus.
                </div>
                <form id="roomForm" onsubmit="event.preventDefault();">
                    <div class="form-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" required placeholder="Your full name">
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" required placeholder="10 digit number" pattern="[0-9]{10}" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label for="roomNumber">Room Number / Location *</label>
                        <input type="text" id="roomNumber" required placeholder="e.g., Room 305, Lab 2, Cafeteria" maxlength="50">
                        <div class="hint-text">Enter your room number, lab, or specific location</div>
                    </div>
                    <div class="form-group">
                        <label for="buildingBlock">Building / Block *</label>
                        <select id="buildingBlock" required>
                            <option value="">Select Building/Block</option>
                            <option value="TIU University Building">TIU University Building</option>
                            <option value="Studio Building">Studio Building</option>
                            <option value="TIU Mains Building">TIU Mains Building</option>
                            <option value="Hostel Block A">Hostel Block A</option>
                            <option value="Hostel Block B">Hostel Block B</option>
                            <option value="Hostel Block C">Hostel Block C</option>
                            <option value="Academic Block">Academic Block</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="landmark">Additional Instructions (Optional)</label>
                        <textarea id="landmark" placeholder="e.g., Near staircase, Ground floor, Call when you arrive" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="saveRoom" checked style="width: auto;">
                            <span>Save for future orders</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <button type="button" class="btn" onclick="APP.saveAndSelectRoom()" style="flex: 1; min-width: 150px;">
                            Deliver Here
                        </button>
                        <button type="button" class="btn-secondary" onclick="APP.showSavedRooms()" id="backToSavedBtn" style="display: none; flex: 1; min-width: 150px;">Back</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getDatabase, ref, push, set, get, remove, update, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTB7d1-tjzU3DG0tvmkh1lWiZcmba10XI",
            authDomain: "hungrybites-c7930.firebaseapp.com",
            projectId: "hungrybites-c7930",
            storageBucket: "hungrybites-c7930.firebasestorage.app",
            messagingSenderId: "346758544945",
            appId: "1:346758544945:web:4bcad30016540d18e79f10",
            measurementId: "G-B5GP5SYMRC",
            databaseURL: "https://hungrybites-c7930-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Global app state
        const APP = {
            cart: [],
            currentUser: null,
            selectedPayment: null,
            deliveryRoom: null,
            savedRooms: [],
            selectedRoomId: null,
            cartSyncListener: null,
            userTotalOrders: 0,
            RAZORPAY_KEY: 'rzp_test_your_key_here',
            FREE_DELIVERY_THRESHOLD: 200,
            DELIVERY_FEE: 40,
            FIRST_TWO_ORDERS_FREE: 1,

            // Initialize app
            init() {
                this.loadCart();
                this.setupAuthListener();
                this.setupEventListeners();
            },

            // Setup event listeners
            setupEventListeners() {
                document.getElementById('roomModal').addEventListener('click', (e) => {
                    if (e.target.id === 'roomModal') this.closeRoomModal();
                });
            },

            // Auth listener
            setupAuthListener() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        this.currentUser = user;
                        await this.initializeUserOrderStats();
                        this.userTotalOrders = await this.getUserTotalOrdersCount();
                        this.syncCartFromDB(user.uid);
                        await this.loadSavedRooms();
                        this.selectPayment('cod');
                        this.renderCart();
                    } else {
                        window.location.href = 'index.html';
                    }
                });
            },

            // Cart operations
            loadCart() {
                try {
                    const saved = localStorage.getItem('tiuBiriyaniCart');
                    this.cart = saved ? JSON.parse(saved) : [];
                } catch (e) {
                    this.cart = [];
                }
            },

            saveCart() {
                try {
                    localStorage.setItem('tiuBiriyaniCart', JSON.stringify(this.cart));
                } catch (e) {
                    console.error('Error saving cart:', e);
                }
            },

            updateQuantity(index, change) {
                this.cart[index].quantity += change;
                if (this.cart[index].quantity <= 0) this.cart.splice(index, 1);
                this.saveCart();
                if (this.currentUser) this.syncCartToDB(this.currentUser.uid);
                this.renderCart();
            },

            removeItem(index) {
                if (confirm('Remove this item?')) {
                    this.cart.splice(index, 1);
                    this.saveCart();
                    if (this.currentUser) this.syncCartToDB(this.currentUser.uid);
                    this.renderCart();
                }
            },

            calculateDeliveryFee(subtotal) {
                if (this.userTotalOrders < this.FIRST_TWO_ORDERS_FREE) return 0;
                return subtotal >= this.FREE_DELIVERY_THRESHOLD ? 0 : this.DELIVERY_FEE;
            },

            renderCart() {
                const content = document.getElementById('cartContent');
                const sections = document.getElementById('checkoutSections');

                if (!this.cart.length) {
                    content.innerHTML = `
                        <div class="empty-cart">
                            <div class="empty-cart-icon">üõí</div>
                            <h3>Your cart is empty</h3>
                            <p>Add delicious biriyani to get started!</p>
                            <a href="home.html" class="continue-shopping">Browse Menu</a>
                        </div>`;
                    sections.style.display = 'none';
                    return;
                }

                sections.style.display = 'block';
                const subtotal = this.cart.reduce((s, i) => s + i.price * i.quantity, 0);
                const deliveryFee = this.calculateDeliveryFee(subtotal);
                const total = subtotal + deliveryFee;

                const isFirstOrders = this.userTotalOrders < this.FIRST_TWO_ORDERS_FREE;
                const isFreeByThreshold = subtotal >= this.FREE_DELIVERY_THRESHOLD;

                const cartHTML = this.cart.map((item, i) => `
                    <div class="cart-item">
                        <div class="cart-item-header">
                            <div class="cart-item-details">
                                <div class="cart-item-name">${item.emoji || ''} ${item.name}</div>
                                <div class="cart-item-price">‚Çπ${item.price}</div>
                            </div>
                            <div class="cart-item-total">‚Çπ${item.price * item.quantity}</div>
                        </div>
                        <div class="cart-item-actions">
                            <div class="cart-item-quantity">
                                <button class="quantity-btn" onclick="APP.updateQuantity(${i}, -1)">‚àí</button>
                                <div class="quantity-display">${item.quantity}</div>
                                <button class="quantity-btn" onclick="APP.updateQuantity(${i}, 1)">+</button>
                            </div>
                            <button class="remove-btn" onclick="APP.removeItem(${i})">Remove</button>
                        </div>
                    </div>
                `).join('');

                const deliveryFeeClass = deliveryFee === 0 ? 'summary-row delivery free' : 'summary-row delivery';
                let deliveryText = '';
                if (isFirstOrders) {
                    deliveryText = `<span>Delivery Fee</span><span><span class="delivery-value">‚Çπ${this.DELIVERY_FEE}</span> <strong>FREE</strong></span>`;
                } else if (isFreeByThreshold) {
                    deliveryText = `<span>Delivery Fee</span><span><span class="delivery-value">‚Çπ${this.DELIVERY_FEE}</span> <strong>FREE</strong></span>`;
                } else {
                    deliveryText = `<span>Delivery Fee</span><span>‚Çπ${deliveryFee}</span>`;
                }

                content.innerHTML = cartHTML + `
                    <div class="cart-summary">
                        <div class="summary-row subtotal"><span>Subtotal</span><span>‚Çπ${subtotal}</span></div>
                        <div class="${deliveryFeeClass}">${deliveryText}</div>
                        <div class="cart-total"><span>Total</span><span>‚Çπ${total}</span></div>
                    </div>`;
            },

            // Sync cart
            syncCartFromDB(userId) {
                if (this.cartSyncListener) this.cartSyncListener();
                const userCartRef = ref(db, `tiutbc/carts/${userId}`);
                this.cartSyncListener = onValue(userCartRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const dbCart = Object.keys(snapshot.val()).map(itemId => ({
                            id: itemId,
                            ...snapshot.val()[itemId]
                        }));
                        if (JSON.stringify(this.cart) !== JSON.stringify(dbCart)) {
                            this.cart = dbCart;
                            this.saveCart();
                            this.renderCart();
                        }
                    }
                });
            },

            syncCartToDB(userId) {
                const userCartRef = ref(db, `tiutbc/carts/${userId}`);
                if (this.cart.length === 0) {
                    remove(userCartRef).catch(e => console.error('Cart removal error:', e));
                    return;
                }
                const cartData = {};
                this.cart.forEach(item => {
                    cartData[item.id] = { name: item.name, price: item.price, emoji: item.emoji, quantity: item.quantity };
                });
                set(userCartRef, cartData).catch(e => console.error('Cart sync error:', e));
            },

            // Room operations
            async loadSavedRooms() {
                if (!this.currentUser) return;
                try {
                    const snap = await get(ref(db, `tiutbc/users/${this.currentUser.uid}/addresses`));
                    this.savedRooms = [];
                    if (snap.exists()) {
                        snap.forEach(child => {
                            this.savedRooms.push({ id: child.key, ...child.val() });
                        });
                        this.savedRooms.sort((a, b) => (b.isDefault ? 1 : 0) - (a.isDefault ? 1 : 0));
                        if (this.savedRooms.length > 0) {
                            const defaultRoom = this.savedRooms.find(r => r.isDefault) || this.savedRooms[0];
                            this.selectedRoomId = defaultRoom.id;
                            this.deliveryRoom = defaultRoom;
                        }
                    }
                    this.renderRoomDisplay();
                } catch (e) {
                    console.error('Load rooms error:', e);
                }
            },

            renderRoomDisplay() {
                const area = document.getElementById('roomDisplayArea');
                if (!this.deliveryRoom) {
                    area.innerHTML = `
                        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 1rem; text-align: center; color: #856404;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è Delivery Location Required</div>
                            <div style="font-size: 0.9rem; margin-bottom: 0.75rem;">Please add your room/building details</div>
                            <button class="btn-secondary" onclick="APP.showRoomModal()">+ Add Delivery Location</button>
                        </div>`;
                    this.updatePlaceOrderButtonState();
                    if (this.savedRooms.length === 0) {
                        setTimeout(() => this.showRoomModal(), 1500);
                    }
                    return;
                }

                area.innerHTML = `
                    <div class="room-display-card">
                        <div class="room-display-header">
                            <div>
                                <div class="room-display-name">${this.deliveryRoom.fullName}</div>
                                <div class="room-display-phone">üì± ${this.deliveryRoom.phone}</div>
                            </div>
                            <button class="change-room-btn" onclick="APP.showRoomModal()">Change</button>
                        </div>
                        <div class="room-display-text">
                            üè¢ <strong>${this.deliveryRoom.buildingBlock}</strong><br>
                            üö™ Room: ${this.deliveryRoom.roomNumber}
                            ${this.deliveryRoom.landmark ? `<br>üìå ${this.deliveryRoom.landmark}` : ''}
                        </div>
                    </div>`;
                this.updatePlaceOrderButtonState();
            },

            renderSavedRooms() {
                const list = document.getElementById('savedRoomsList');
                const form = document.getElementById('roomFormContainer');
                const cards = document.getElementById('roomCards');

                if (!this.savedRooms.length) {
                    list.style.display = 'none';
                    form.style.display = 'block';
                    document.getElementById('backToSavedBtn').style.display = 'none';
                    return;
                }

                list.style.display = 'block';
                form.style.display = 'none';

                cards.innerHTML = this.savedRooms.map((r) => {
                    const selectedClass = this.selectedRoomId === r.id ? 'selected' : '';
                    return `
                        <div class="room-card ${selectedClass}" onclick="APP.selectSavedRoom('${r.id}')">
                            <div class="room-card-header">
                                <div>
                                    <div class="room-name">${r.fullName}</div>
                                    <div class="room-phone">üì± ${r.phone}</div>
                                </div>
                                ${r.isDefault ? '<span class="default-badge">Default</span>' : ''}
                            </div>
                            <div class="room-details">
                                üè¢ <strong>${r.buildingBlock}</strong><br>
                                üö™ Room: ${r.roomNumber}
                                ${r.landmark ? `<br>üìå ${r.landmark}` : ''}
                            </div>
                            <div class="room-actions">
                                ${!r.isDefault ? `<button class="btn-small btn-set-default" onclick="event.stopPropagation(); APP.setDefaultRoom('${r.id}')">Set as Default</button>` : ''}
                                <button class="btn-small btn-delete" onclick="event.stopPropagation(); APP.deleteRoom('${r.id}')">Delete</button>
                            </div>
                        </div>`;
                }).join('');
            },

            selectSavedRoom(id) {
                const found = this.savedRooms.find(r => r.id === id);
                if (!found) return;
                
                this.selectedRoomId = id;
                this.deliveryRoom = found;
                this.renderRoomDisplay();
                setTimeout(() => this.closeRoomModal(), 300);
            },

            async setDefaultRoom(id) {
                if (!this.currentUser) return;
                try {
                    const updates = {};
                    this.savedRooms.forEach(room => {
                        updates[`tiutbc/users/${this.currentUser.uid}/addresses/${room.id}/isDefault`] = (room.id === id);
                    });
                    await update(ref(db), updates);
                    this.savedRooms.forEach(room => {
                        room.isDefault = (room.id === id);
                    });
                    this.savedRooms.sort((a, b) => (b.isDefault ? 1 : 0) - (a.isDefault ? 1 : 0));
                    this.renderSavedRooms();
                    this.showSuccess('Default location updated');
                } catch (e) {
                    console.error('Set default error:', e);
                    this.showError('Failed to set default');
                }
            },

            async deleteRoom(id) {
                if (!confirm('Delete this location?')) return;
                try {
                    await remove(ref(db, `tiutbc/users/${this.currentUser.uid}/addresses/${id}`));
                    this.savedRooms = this.savedRooms.filter(r => r.id !== id);
                    if (this.selectedRoomId === id) {
                        this.selectedRoomId = null;
                        this.deliveryRoom = null;
                        if (this.savedRooms.length) {
                            const defaultRoom = this.savedRooms.find(r => r.isDefault) || this.savedRooms[0];
                            this.selectedRoomId = defaultRoom.id;
                            this.deliveryRoom = defaultRoom;
                        }
                    }
                    this.renderSavedRooms();
                    this.renderRoomDisplay();
                    this.showSuccess('Location deleted');
                } catch (e) {
                    console.error('Delete error:', e);
                    this.showError('Failed to delete');
                }
            },

            showRoomModal() {
                const modal = document.getElementById('roomModal');
                modal.classList.add('active');
                if (this.savedRooms.length > 0) {
                    this.showSavedRooms();
                } else {
                    this.showRoomForm();
                }
            },

            closeRoomModal() {
                document.getElementById('roomModal').classList.remove('active');
            },

            showRoomForm() {
                document.getElementById('savedRoomsList').style.display = 'none';
                document.getElementById('roomFormContainer').style.display = 'block';
                document.getElementById('backToSavedBtn').style.display = this.savedRooms.length ? 'block' : 'none';
                document.getElementById('roomForm').reset();
                document.getElementById('saveRoom').checked = true;
            },

            showSavedRooms() {
                document.getElementById('savedRoomsList').style.display = 'block';
                document.getElementById('roomFormContainer').style.display = 'none';
                this.renderSavedRooms();
            },

            async saveAndSelectRoom() {
                const name = document.getElementById('fullName').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const roomNumber = document.getElementById('roomNumber').value.trim();
                const buildingBlock = document.getElementById('buildingBlock').value.trim();
                const landmark = document.getElementById('landmark').value.trim();
                const save = document.getElementById('saveRoom').checked;

                if (!name || !phone || !roomNumber || !buildingBlock) {
                    return this.showError('Please fill all required fields');
                }
                if (!/^[0-9]{10}$/.test(phone)) {
                    return this.showError('Please enter valid 10-digit phone number');
                }

                try {
                    this.deliveryRoom = {
                        fullName: name,
                        phone,
                        roomNumber,
                        buildingBlock,
                        landmark
                    };

                    if (save && this.currentUser) {
                        const newRef = push(ref(db, `tiutbc/users/${this.currentUser.uid}/addresses`));
                        const isFirstRoom = this.savedRooms.length === 0;
                        await set(newRef, { ...this.deliveryRoom, createdAt: Date.now(), isDefault: isFirstRoom });
                        this.savedRooms.push({ id: newRef.key, ...this.deliveryRoom, isDefault: isFirstRoom });
                        this.selectedRoomId = newRef.key;
                    }
                    
                    this.showSuccess('Delivery location set successfully');
                    this.renderRoomDisplay();
                    this.closeRoomModal();
                } catch (e) {
                    console.error('Error saving room:', e);
                    this.showError('Failed to save location');
                }
            },

            // Payment operations
            selectPayment(method) {
                this.selectedPayment = method;
                document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
                const radio = document.getElementById(method);
                if (radio) radio.checked = true;
                const opt = document.getElementById(`payment-${method}`);
                if (opt) opt.classList.add('selected');
                this.updatePlaceOrderButtonState();
            },

            updatePlaceOrderButtonState() {
                const btn = document.getElementById('placeOrderBtn');
                const enabled = !!this.deliveryRoom && !!this.selectedPayment;
                btn.disabled = !enabled;
                if (this.selectedPayment === 'cod') btn.textContent = 'Place Order (COD)';
                else if (this.selectedPayment === 'online') btn.textContent = 'Pay Now';
                else btn.textContent = 'Select Payment Method';
            },

            async handlePlaceOrder() {
                if (!this.deliveryRoom) {
                    this.showError('Please add delivery location');
                    this.showRoomModal();
                    return;
                }
                
                if (!this.selectedPayment) return this.showError('Please select payment method');

                const snap = await get(ref(db, 'tiutbc/storeStatus/isOpen'));
                if (!snap.exists() || !snap.val()) {
                    return this.showToast('error', 'Store Closed', 'We are not taking orders right now. Please try again later.');
                }

                this.selectedPayment === 'cod' ? this.placeOrder('cod', null) : this.initiateRazorpay();
            },

            initiateRazorpay() {
                const subtotal = this.cart.reduce((s, i) => s + i.price * i.quantity, 0);
                const deliveryFee = this.calculateDeliveryFee(subtotal);
                const total = subtotal + deliveryFee;

                new Razorpay({
                    key: this.RAZORPAY_KEY,
                    amount: total * 100,
                    currency: 'INR',
                    name: 'TIU The Biriyani Canteen',
                    description: 'Food Order',
                    handler: (res) => this.placeOrder('online', res.razorpay_payment_id),
                    prefill: { name: this.deliveryRoom.fullName, email: this.currentUser.email, contact: this.deliveryRoom.phone },
                    theme: { color: '#ff6b35' },
                    modal: { ondismiss: () => this.showError('Payment cancelled') }
                }).open();
            },

            async placeOrder(method, paymentId) {
                if (!this.currentUser || !this.cart.length) return this.showError('Unable to place order');

                const loader = document.getElementById('loader');
                const btn = document.getElementById('placeOrderBtn');
                loader.style.display = 'block';
                btn.disabled = true;

                const subtotal = this.cart.reduce((s, i) => s + i.price * i.quantity, 0);
                const deliveryFee = this.calculateDeliveryFee(subtotal);
                const total = subtotal + deliveryFee;

                const isFirstOrder = this.userTotalOrders === 0;
                const isFreeByThreshold = subtotal >= this.FREE_DELIVERY_THRESHOLD;

                try {
                    const newOrderRef = push(ref(db, 'tiutbc/orders'));
                    const orderId = newOrderRef.key;
                    
                    // Structure: /tiutbc/orders/{orderId}/userDetails and /tiutbc/orders/{orderId}/orderDetails
                    const orderData = {
                        userDetails: {
                            userId: this.currentUser.uid,
                            userEmail: this.currentUser.email,
                            fullName: this.deliveryRoom.fullName,
                            phone: this.deliveryRoom.phone,
                            roomNumber: this.deliveryRoom.roomNumber,
                            buildingBlock: this.deliveryRoom.buildingBlock,
                            landmark: this.deliveryRoom.landmark || ''
                        },
                        orderDetails: {
                            items: this.cart,
                            subtotal,
                            deliveryFee,
                            total,
                            freeDelivery: deliveryFee === 0,
                            freeDeliveryReason: isFirstOrder ? 'first_order' : (isFreeByThreshold ? 'threshold' : null),
                            paymentMethod: method,
                            paymentStatus: method === 'online' ? 'paid' : 'pending',
                            ...(paymentId && { paymentId }),
                            status: 'pending',
                            createdAt: Date.now(),
                            orderNumber: orderId.slice(-6).toUpperCase()
                        }
                    };
                    
                    await set(newOrderRef, orderData);

                    const totalOrdersRef = ref(db, `tiutbc/users/${this.currentUser.uid}/orderStats/totalOrders`);
                    const totalOrdersSnap = await get(totalOrdersRef);
                    const currentTotal = totalOrdersSnap.exists() ? totalOrdersSnap.val() : 0;
                    await set(totalOrdersRef, currentTotal + 1);

                    this.showToast('success', 'Order Placed Successfully!', 'Redirecting to My Orders...');
                    localStorage.removeItem('tiuBiriyaniCart');
                    this.cart = [];
                    if (this.currentUser) {
                        await remove(ref(db, `tiutbc/carts/${this.currentUser.uid}`)).catch(e => console.log('Cart cleanup:', e));
                    }
                    setTimeout(() => window.location.href = 'orders.html', 2500);
                } catch (e) {
                    console.error('Order error:', e);
                    this.showError('Failed to place order');
                    loader.style.display = 'none';
                    btn.disabled = false;
                }
            },

            // User order stats
            async initializeUserOrderStats() {
                if (!this.currentUser) return;
                try {
                    const statsRef = ref(db, `tiutbc/users/${this.currentUser.uid}/orderStats`);
                    const snapshot = await get(statsRef);
                    if (!snapshot.exists()) {
                        await set(statsRef, { completedOrders: 0, totalOrders: 0, createdAt: Date.now() });
                    }
                } catch (e) {
                    console.error('Error initializing order stats:', e);
                }
            },

            async getUserTotalOrdersCount() {
                if (!this.currentUser) return 0;
                try {
                    const statsRef = ref(db, `tiutbc/users/${this.currentUser.uid}/orderStats/totalOrders`);
                    const snapshot = await get(statsRef);
                    return snapshot.exists() ? snapshot.val() || 0 : 0;
                } catch (e) {
                    console.error('Error getting total order count:', e);
                    return 0;
                }
            },

            // UI helpers
            showToast(type, msg, sub) {
                const toast = document.getElementById('toast');
                const overlay = document.getElementById('toastOverlay');
                toast.className = `toast show toast-${type}`;
                overlay.classList.add('show');
                document.getElementById('toastIcon').textContent = type === 'success' ? '‚úì' : '‚úï';
                document.getElementById('toastMessage').textContent = msg;
                document.getElementById('toastSubMessage').textContent = sub;
                if (type === 'error') {
                    setTimeout(() => {
                        toast.classList.remove('show');
                        overlay.classList.remove('show');
                    }, 4000);
                }
            },

            showSuccess(msg) {
                const el = document.getElementById('successMessage');
                el.textContent = msg;
                el.style.display = 'block';
                setTimeout(() => el.style.display = 'none', 3000);
            },

            showError(msg) {
                const el = document.getElementById('errorMessage');
                el.textContent = msg;
                el.style.display = 'block';
                setTimeout(() => el.style.display = 'none', 3000);
            },

            toggleMenu() {
                document.querySelector('.hamburger').classList.toggle('active');
                document.getElementById('navMenu').classList.toggle('active');
            },

            async logout() {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        if (this.cartSyncListener) this.cartSyncListener();
                        await signOut(auth);
                        localStorage.removeItem('tiuBiriyaniCart');
                        window.location.href = 'index.html';
                    } catch (e) {
                        console.error('Logout error:', e);
                    }
                }
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            APP.init();
        });

        // Expose APP to global scope
        window.APP = APP;
    </script>
</body>
</html>
